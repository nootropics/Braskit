{#
 # Thread macros
 #}

{% macro thread(context, posts) %}
	{% from _self import fileinfo, thumb, head, body, reply -%}

	<article class="post thread" id="{{ posts[0].id }}">
		{% for p in posts %}
			{% if not p.parent %}
        {% set files = p.getFiles() %}

        {% if files|length == 1 %}
          {{ fileinfo(context, files[0]) }}
          {{ thumb(context, files[0]) }}
        {% endif %}

        {{ head(context, p, files) }}
        {{ body(context, p, files) }}

				{% if p.omitted %}
					<p class="post-omitted">{{ p.omitted|raw }} posts omitted. Click Reply to view.</p>
				{% endif %}
			{% else %}
				{{ reply(context, p) }}
			{% endif %}
		{% endfor %}
	</article>
{% endmacro %}

{% macro head(context, p) -%}
	<h2 class="post-info">
		<label>
      {# Checkbox #}
			<input type="checkbox" name="id[]" value="{{ p.id|raw }}">

      {# Post subject #}
			{% if p.subject %}
				<span class="post-subject">{{ p.subject|raw }}</span>
			{% endif %}

      {# Poster's name/email/trip #}
      {% if p.email %}
        <span class="post-name"><a href="{{ p.email|raw }}">{{ p.name|raw }}</a></span>

        {%- if p.tripcode -%}
          <span class="post-trip"><a href="{{ p.email|raw }}"> {{ p.tripcode|raw }}</a></span>
        {% endif %}
      {% else %}
        <span class="post-name">{{ p.name|raw }}</span>

        {% if p.tripcode %}
          <span class="post-trip">{{ p.tripcode|raw }}</span>
        {% endif %}
      {% endif %}

      {# Show IP for moderators #}
			{% if context.admin %}
				<span class="post-ip">(<a href="{{ path("IP/"~p.ip, true) }}">{{ p.ip|raw }}</a>)</span>
			{% endif %}

			<span class="post-date">{{ p.getDate()|date(context.board.config.get("date_format")) }}</span>
		</label>

		{% spaceless %}
      {% if not context.thread %}
        <a href="{{ context.board.linkToPost(p, false, context.admin) }}" class="ref-link no" data-num="{{ p.id|raw }}">No.</a>
        <a href="{{ context.board.linkToPost(p, true, context.admin) }}" class="ref-link val" data-num="{{ p.id|raw }}">{{ p.id|raw }}</a>
      {% else %}
        <a href="#{{ p.id|raw }}" class="ref-link no" data-num="{{ p.id|raw }}">No.</a>
        <a href="#i{{ p.id|raw }}" class="ref-link val" data-num="{{ p.id|raw }}">{{ p.id }}</a>
      {% endif %}
		{% endspaceless %}

		{% if not p.parent and not context.thread %}
			<span class="reply-link">[<a href="{{ context.board.path("res/"~p.id~".html", context.admin) }}">Reply</a>]</span>
		{% endif %}

    {% if context.admin %}
      <span class="post-mod">
        <a href="{{ context.board.path("delete", {"id": p.id}) }}" title="Delete">D</a>
        <a href="{{ context.board.path("delete", {"id": p.id, "ban": 1}) }}" title="Ban & Delete">&</a>
        <a href="{{ context.board.path("ban", {"id": p.id}) }}" title="Ban">B</a>
      </span>
    {% endif %}
	</h2>
{% endmacro %}

{% macro fileinfo(context, file) %}
	<p class="post-file">
		File: <a href="{{ context.board.path("src/"~file.file) }}" target="_blank">{{ file.file }}</a>
		<em>(
			{{- file.prettysize|raw }}, {{ file.width|raw }}x{{ file.height|raw -}}
			{%- if context.thread and file.origname %},
				<span title="{{ file.origname }}">{{ file.shortname }}</span>
			{%- endif -%}
		)</em>
	</p>
{% endmacro %}

{# Macro for single thumbnail #}
{% macro thumb(context, p) %}
	{% import _self as m %}

  {% if p.t_width and p.t_height %}
    <a href="{{ context.board.path("src/"~p.file) }}" class="thumb-link" target="_blank">
      <img src="{{ context.board.path("thumb/"~p.thumb) }}" alt="" class="thumb thumb-single" width="{{ p.t_width|raw }}" height="{{ p.t_height|raw }}">
    </a>
  {% else %}
    <a href="{{ context.board.path("src/"~p.file) }}" class="no-thumb">(No thumbnail)</a>
  {% endif %}
{% endmacro %}

{# Macro for thumbnail grid #}
{% macro thumbgrid(context, files) %}
  <div class="thumb-grid">
    {% for file in files %}
      <div class="item">
        <p class="thumb-info">
          <label>
            <input type="checkbox" name="fileid[]" value="{{ file.id }}">
            {{ file.shortname }} ({{ file.width|raw }}x{{ file.height|raw }})
          </label>
        </p>

        <p class="thumb">
          <a href="{{ context.board.path("src/"~file.file) }}" class="thumb-link" target="_blank">
            <img src="{{ context.board.path("thumb/"~file.thumb) }}" alt="" class="thumb thumb-multiple" width="{{ file.t_width|raw }}" height="{{ file.t_height|raw }}">
          </a>
        </p>
      </div>
    {% endfor %}
  </div>
{% endmacro %}

{% macro reports(reports) %}
  {% if reports %}
    <div class="post-reports">
      <ul>
        {% for report in reports %}
          <li>
            Reported by <a href="{{ path("ip/"~report.ip, true) }}">{{ report.ip }}</a>: <strong class="reason">{{ report.reason }}</strong>
            <span class="dismiss">(<a href="{{ path("reports", {"dismiss": report.id}) }}" title="Dismiss">Dismiss</a>)</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endmacro %}

{% macro body(context, p, files=[]) %}
	{% import _self as m %}

  <div class="post-body">
    {% if files and files|length > 1 %}
      {{ m.thumbgrid(context, files) }}
    {% endif %}

    <div class="post-comment">
      {{- p.comment|raw -}}
    </div>

    <footer class="post-footer">
      {% if p.abbrev %}
        <p class="post-abbr">Comment too long. Click <a href="">here</a> to view the full text.</p>
      {% endif %}

      {% if context.showinfo %}
        <p class="post-modinfo">
          Board: <strong>/{{ context.board|raw }}/</strong>{% if p.parent %}, thread: <strong>{{ p.parent|raw }}</strong></li>{% endif %}
        </p>
      {% endif %}

      {% if context.admin %}
        {{ m.reports(p.getReports()) }}
      {% endif %}
    </footer>
  </div>
{% endmacro %}

{% macro op(context, p) %}
	{% import _self as m -%}

{% endmacro %}

{% macro reply(context, p) %}
	{% import _self as m -%}

	<article class="post reply" id="{{ p.id|raw }}">
		<div class="reply-indent">&gt;&gt;</div>

		<div class="reply-inner">
			{{ m.head(context, p) }}

      {% set files = p.getFiles() %}

			{% if files|length == 1%}
				{{ m.fileinfo(context, files[0]) }}
				{{ m.thumb(context, files[0]) }}
      {% elseif files|length > 1 %}
        {{ m.thumbgrid(context, files) }}
			{% endif %}

			{{ m.body(context, p) }}
		</div>
	</article>
{% endmacro %}


{#
 # Links and stuff
 #}

{% macro make_previous_page_button(context) -%}
	{% import _self as m %}

  {% if not context.pagenum %}
    <div class="cell previous disabled">Previous</div>
  {% else %}
    {% if not context.admin %}
      <form action="{{ context.board.path(context.pagenum == 1 ? "index.html" : (context.pagenum - 1)~".html", context.admin) }}" method="get" class="cell previous">
        <input type="submit" value="Previous" onclick="window.location='{{ context.board.path(context.pagenum == 1 ? "index.html" : (context.pagenum - 1)~".html", context.admin) }}';return false">
      </form>
    {% else %}
      <div class="cell previous">
        <a href="{{ context.board.path((context.pagenum - 1)~".html", true) }}">Previous</a>
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro make_next_page_button(context) %}
	{% import _self as m %}

  {% if context.pagenum == context.maxpage %}
    <div class="cell next disabled">Next</div>
  {% else %}
    {% if not context.admin %}
      <form action="{{ context.board.path((context.pagenum + 1)~".html") }}" method="get" class="cell next">
        <input type="submit" value="Next" onclick="window.location='{{ context.board.path((context.pagenum + 1)~".html") }}';return false">
      </form>
    {% else %}
      <div class="cell next">
        <a href="{{ context.board.path((context.pagenum + 1)~".html", true) }}">Next</a>
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}


{#
 # Various
 #}

{% macro returnlink(context, dest="") -%}
	{% if dest %}
		[<a href="{{ dest }}">Return</a>]
	{% elseif context.board %}
		[<a href="{{ context.board.path("index.html", context.admin) }}">Return</a>]
  {% else %}
    [<a href="{{ path("index.html") }}">Return</a>]
	{% endif %}
{%- endmacro %}
